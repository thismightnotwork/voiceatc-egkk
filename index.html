<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ATC Trainer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#020617" />

  <!-- Minimal inline manifest-style info for PWA installs -->
  <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAADklEQVR4Ae3BAQ0AAADCoPdPbQ43oAAAAABJRU5ErkJggg==" />

  <!-- Puter.js SDK -->
  <script src="https://js.puter.com/v2/"></script>

  <style>
    :root {
      color-scheme: dark;
      --bg: #020617;
      --primary: #38bdf8;
      --danger: #f97373;
      --border-subtle: rgba(148,163,184,0.35);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-full: 999px;
      --shadow-soft: 0 18px 40px rgba(15,23,42,0.8);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: radial-gradient(circle at top, #0f172a, #020617);
      color: var(--text-main);
      display: flex;
      align-items: stretch;
      justify-content: center;
    }
    .app-shell {
      width: 100%;
      max-width: 960px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top left, rgba(56,189,248,0.22), rgba(15,23,42,0.95));
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(20px);
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .brand-mark {
      width: 32px;
      height: 32px;
      border-radius: 12px;
      background: conic-gradient(from 210deg, #38bdf8, #22c55e, #38bdf8);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #0f172a;
      font-size: 16px;
      font-weight: 700;
      box-shadow: 0 0 0 2px rgba(15,23,42,0.9);
    }
    .brand-text-title {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }
    .brand-text-sub {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-muted);
    }
    main {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2.2fr);
      gap: 16px;
    }
    @media (max-width: 780px) {
      main { grid-template-columns: 1fr; }
    }
    .card {
      background: rgba(15,23,42,0.92);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .card-title {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-muted);
    }
    .status-pill {
      padding: 4px 10px;
      border-radius: var(--radius-full);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      border: 1px solid rgba(148,163,184,0.4);
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #4ade80;
    }
    .status-pill.error .status-dot { background: var(--danger); }
    .status-pill.listening {
      border-color: rgba(56,189,248,0.85);
      color: var(--primary);
    }
    .status-pill.listening .status-dot {
      background: var(--primary);
      animation: pulse 1.2s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(0.9); opacity: 0.7; }
      50% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(0.9); opacity: 0.7; }
    }
    .transcript {
      flex: 1;
      border-radius: var(--radius-md);
      background: radial-gradient(circle at top left, rgba(56,189,248,0.08), rgba(15,23,42,0.95));
      border: 1px solid rgba(148,163,184,0.4);
      padding: 10px 12px;
      font-size: 14px;
      line-height: 1.5;
      color: var(--text-main);
      min-height: 80px;
      white-space: pre-wrap;
    }
    .transcript.placeholder {
      color: var(--text-muted);
      font-style: italic;
    }
    .meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      font-size: 11px;
      color: var(--text-muted);
    }
    .meta-row span strong {
      color: var(--text-main);
      font-weight: 500;
    }
    .ptt-wrapper {
      margin-top: 10px;
      display: flex;
      justify-content: center;
    }
    .ptt {
      -webkit-appearance: none;
      appearance: none;
      border: none;
      outline: none;
      cursor: pointer;
      width: 140px;
      height: 140px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 10%, #38bdf8, #0f172a);
      color: #e5e7eb;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      box-shadow:
        0 18px 30px rgba(15,23,42,0.9),
        0 0 0 1px rgba(148,163,184,0.5);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.12s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .ptt-label-main { font-size: 12px; }
    .ptt-label-sub { font-size: 10px; opacity: 0.8; }
    .ptt:active {
      transform: translateY(2px) scale(0.98);
      box-shadow:
        0 10px 18px rgba(8,14,28,0.95),
        0 0 0 1px rgba(56,189,248,0.7);
    }
    .ptt.recording {
      background: radial-gradient(circle at 30% 10%, #ef4444, #0f172a);
      box-shadow:
        0 20px 40px rgba(127,29,29,0.9),
        0 0 0 1px rgba(248,113,113,0.9);
    }
    footer {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .pill {
      border-radius: var(--radius-full);
      padding: 3px 10px;
      border: 1px solid rgba(148,163,184,0.4);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="brand">
        <div class="brand-mark">ATC</div>
        <div>
          <div class="brand-text-title">ATC Trainer</div>
          <div class="brand-text-sub">Voice · STT · AI · TTS</div>
        </div>
      </div>
      <div class="pill">Add to Home Screen on iOS</div>
    </header>

    <main>
      <!-- Left: ATC (you) -->
      <section class="card">
        <div class="card-header">
          <div class="card-title">ATC Transmission (You)</div>
          <div id="status-pill" class="status-pill">
            <span class="status-dot"></span>
            <span id="status-label">Idle</span>
          </div>
        </div>
        <div id="you" class="transcript placeholder">
          Hold the button and speak, for example:
          “Golf Oscar Lima Foxtrot, runway two seven cleared for takeoff.”
        </div>
        <div class="meta-row">
          <span>Last STT: <strong id="stt-latency">–</strong></span>
          <span>AI + TTS: <strong id="ai-latency">–</strong></span>
        </div>
        <div class="ptt-wrapper">
          <button id="ptt" class="ptt" type="button">
            <span class="ptt-label-main">Push to Talk</span>
            <span class="ptt-label-sub">Hold while speaking</span>
          </button>
        </div>
      </section>

      <!-- Right: Pilot (AI) -->
      <section class="card">
        <div class="card-header">
          <div class="card-title">Pilot (AI)</div>
        </div>
        <div id="pilot" class="transcript placeholder">
          Pilot AI replies will appear here and will be spoken automatically.
        </div>
      </section>
    </main>

    <footer>
      <span>Powered by Puter.js STT · AI · TTS</span>
      <span>Single-page, PWA-friendly UI</span>
    </footer>
  </div>

  <script>
    const pttBtn = document.getElementById('ptt');
    const statusLabel = document.getElementById('status-label');
    const statusPill = document.getElementById('status-pill');
    const youDiv = document.getElementById('you');
    const pilotDiv = document.getElementById('pilot');
    const sttLatencySpan = document.getElementById('stt-latency');
    const aiLatencySpan = document.getElementById('ai-latency');

    let mediaRecorder;
    let chunks = [];

    function setStatus(mode, text) {
      statusLabel.textContent = text;
      statusPill.classList.remove('error', 'listening');
      if (mode === 'listening') statusPill.classList.add('listening');
      if (mode === 'error') statusPill.classList.add('error');
    }

    async function initMedia() {
      if (mediaRecorder) return;
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => {
          if (e.data && e.data.size > 0) chunks.push(e.data);
        };
        mediaRecorder.onstop = onStopRecording;
      } catch (err) {
        setStatus('error', 'Mic error');
        youDiv.textContent = 'Mic error: ' + err.message;
        youDiv.classList.remove('placeholder');
      }
    }

    async function askPilotAI(atcText) {
      const systemPrompt =
        "You are the pilot in a UK CAA CAP 413 style RTF exchange. " +
        "You receive ATC transmissions as text. " +
        "Your job is to produce a SINGLE, realistic pilot readback. " +
        "Rules:\n" +
        "- Use standard ICAO/CAA radiotelephony phraseology, UK style.\n" +
        "- Identify the aircraft once per transmission using its callsign in the NATO phonetic alphabet.\n" +
        "- Put the clearance or readback FIRST, and the callsign LAST. Example: 'cleared for takeoff runway two seven, Golf Oscar Lima Foxtrot.'\n" +
        "- Be concise: only read back what is required (clearances, runway, level, QNH, squawk etc.).\n" +
        "- Do NOT include any explanations or extra text, only the pilot’s spoken transmission.";

      const messages = [
        { role: "system", content: systemPrompt },
        { role: "user", content: "ATC transmission: \"" + atcText + "\"" }
      ];

      const t0 = performance.now();
      const resp = await puter.ai.chat(messages, {
        model: "gpt-5-nano",
        stream: false
      });
      const t1 = performance.now();
      aiLatencySpan.textContent = ((t1 - t0) / 1000).toFixed(2) + "s";

      if (typeof resp === "string") return resp;
      if (resp?.message?.content) return resp.message.content;
      if (resp?.choices?.[0]?.message?.content) return resp.choices[0].message.content;

      return "say again, please.";
    }

    async function speak(text) {
      const t0 = performance.now();
      const audio = await puter.ai.txt2speech(text, { language: "en-GB" });
      await audio.play();
      const t1 = performance.now();
      // Fold TTS time into AI latency display if you like, or leave as-is
      const current = parseFloat(aiLatencySpan.textContent) || 0;
      aiLatencySpan.textContent = (current + (t1 - t0) / 1000).toFixed(2) + "s";
    }

    async function onStopRecording() {
      statusLabel.textContent = "Transcribing...";
      statusPill.classList.remove('listening');
      const blob = new Blob(chunks, { type: "audio/webm" });
      chunks = [];

      try {
        const sttStart = performance.now();
        const result = await puter.ai.speech2txt(blob);
        const sttEnd = performance.now();
        sttLatencySpan.textContent = ((sttEnd - sttStart) / 1000).toFixed(2) + "s";

        const atcText = result.text || result || "";
        youDiv.textContent = atcText || "(No speech recognised)";
        youDiv.classList.remove('placeholder');

        if (!atcText) {
          const fallback = "no transmission received, say again.";
          pilotDiv.textContent = fallback;
          pilotDiv.classList.remove('placeholder');
          await speak(fallback);
          statusLabel.textContent = "Ready";
          return;
        }

        statusLabel.textContent = "AI generating reply...";
        const pilotText = await askPilotAI(atcText);
        pilotDiv.textContent = pilotText;
        pilotDiv.classList.remove('placeholder');

        statusLabel.textContent = "Speaking...";
        await speak(pilotText);
        statusLabel.textContent = "Ready";
      } catch (err) {
        console.error(err);
        statusLabel.textContent = "Error";
        statusPill.classList.add('error');
      }
    }

    // PTT handlers – same logic as your basic version
    pttBtn.addEventListener("mousedown", async () => {
      await initMedia();
      if (!mediaRecorder) return;
      chunks = [];
      mediaRecorder.start();
      pttBtn.classList.add("recording");
      setStatus('listening', 'Recording ATC...');
    });

    pttBtn.addEventListener("mouseup", () => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        pttBtn.classList.remove("recording");
        statusLabel.textContent = "Processing...";
        statusPill.classList.remove('listening');
      }
    });

    pttBtn.addEventListener("mouseleave", () => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        pttBtn.classList.remove("recording");
        statusLabel.textContent = "Processing...";
        statusPill.classList.remove('listening');
      }
    });

    // Touch support for iOS
    pttBtn.addEventListener("touchstart", async (e) => {
      e.preventDefault();
      await initMedia();
      if (!mediaRecorder) return;
      chunks = [];
      mediaRecorder.start();
      pttBtn.classList.add("recording");
      setStatus('listening', 'Recording ATC...');
    }, { passive: false });

    pttBtn.addEventListener("touchend", (e) => {
      e.preventDefault();
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        pttBtn.classList.remove("recording");
        statusLabel.textContent = "Processing...";
        statusPill.classList.remove('listening');
      }
    }, { passive: false });
  </script>
</body>
</html>
